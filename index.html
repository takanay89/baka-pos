<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>POS Kassir</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <script>
    (async function() {
      const SUPABASE_URL = "https://mpwyzefkazbgnastcahd.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wd3l6ZWZrYXpiZ25hc3RjYWhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDg4NTUsImV4cCI6MjA4NTAyNDg1NX0.9bcksevoXtniNvcUiFYhcmWzd8xHDmsY75FJljPO-_4";
      const COMPANY_ID = "18b94000-046c-476b-a0f9-ab813e57e3d7";
      
      // Check for Magic Link token in URL
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      
      if (accessToken) {
        // Magic Link callback - process token
        try {
          const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          const { data: { user }, error } = await db.auth.getUser(accessToken);
          
          if (user && !error) {
            const userData = {
              id: user.id,
              email: user.email,
              name: user.user_metadata?.name || user.email.split('@')[0],
              company_id: COMPANY_ID,
              role: 'admin'
            };
            localStorage.setItem('kassir_user', JSON.stringify(userData));
            window.CURRENT_USER = userData;
            window.COMPANY_ID = COMPANY_ID;
            // Clear hash from URL
            history.replaceState(null, '', window.location.pathname);
            return; // Continue loading app
          }
        } catch (e) {
          console.error('Magic link error:', e);
        }
      }
      
      // Normal auth check
      const savedUser = localStorage.getItem('kassir_user');
      if (!savedUser) { 
        window.location.replace('login.html'); 
        return; 
      }
      try {
        const user = JSON.parse(savedUser);
        if (!user.id || !user.company_id) { 
          localStorage.removeItem('kassir_user'); 
          window.location.replace('login.html'); 
          return; 
        }
        window.CURRENT_USER = user;
        window.COMPANY_ID = user.company_id;
      } catch(e) { 
        localStorage.clear(); 
        window.location.replace('login.html'); 
      }
    })();
  </script>

  <!-- STATUS BAR -->
  <div class="status-bar" id="statusBar">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
  </div>

  <!-- TOP HEADER -->
  <header class="top-header">
    <div class="store-selector">
      <span class="selector-label">–¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞:</span>
      <select id="storeSelect" class="store-select"><option value="main">–û—Å–Ω–æ–≤–Ω–∞—è</option></select>
    </div>
    <div class="user-profile">
      <span class="user-name" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
      <button class="btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="logo"><div class="logo-icon">K</div><span class="logo-text">Kassir</span></div>
    </div>
    <div class="nav-items">
      <button class="nav-item active" data-section="trading" onclick="showSection('trading')"><span class="nav-icon">üõí</span><span class="nav-label">–¢–æ—Ä–≥–æ–≤–ª—è</span></button>
      <button class="nav-item" data-section="products" onclick="showSection('products')"><span class="nav-icon">üì¶</span><span class="nav-label">–¢–æ–≤–∞—Ä—ã</span></button>
      <button class="nav-item" data-section="suppliers" onclick="showSection('suppliers')"><span class="nav-icon">üöö</span><span class="nav-label">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</span></button>
      <button class="nav-item" data-section="clients" onclick="showSection('clients')"><span class="nav-icon">üë•</span><span class="nav-label">–ö–ª–∏–µ–Ω—Ç—ã</span></button>
      <button class="nav-item" data-section="expenses" onclick="showSection('expenses')"><span class="nav-icon">üí∏</span><span class="nav-label">–†–∞—Å—Ö–æ–¥—ã</span></button>
      <button class="nav-item" data-section="reports" onclick="showSection('reports')"><span class="nav-icon">üìä</span><span class="nav-label">–û—Ç—á—ë—Ç—ã</span></button>
      <button class="nav-item" data-section="money" onclick="showSection('money')"><span class="nav-icon">üí∞</span><span class="nav-label">–î–µ–Ω—å–≥–∏</span></button>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <!-- TRADING -->
    <section class="section active" id="section-trading">
      <div class="section-header"><h1 class="section-title">–¢–æ—Ä–≥–æ–≤–ª—è</h1></div>
      <div class="tabs">
        <button class="tab active" onclick="setMode('sale')">–ü—Ä–æ–¥–∞–∂–∞</button>
        <button class="tab" onclick="setMode('receive')">–ü—Ä–∏—Ö–æ–¥</button>
        <button class="tab" onclick="setMode('return')">–í–æ–∑–≤—Ä–∞—Ç</button>
        <button class="tab" onclick="setMode('writeoff')">–°–ø–∏—Å–∞–Ω–∏–µ</button>
        <button class="tab" onclick="setMode('supplier_return')">–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫—É</button>
      </div>
      <div class="trading-grid">
        <div class="trading-left">
          <div class="card mini-report-card" id="miniReportCard">
            <div class="card-title" id="miniReportTitle">–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ –¥–µ–Ω—å</div>
            <div class="period-buttons">
              <button class="period-btn active" data-period="day" onclick="changePeriod('day')">–î–µ–Ω—å</button>
              <button class="period-btn" data-period="week" onclick="changePeriod('week')">–ù–µ–¥–µ–ª—è</button>
              <button class="period-btn" data-period="month" onclick="changePeriod('month')">–ú–µ—Å—è—Ü</button>
            </div>
            <div class="mini-report-stats">
              <div class="mini-stat"><span class="mini-stat-label">–û–ø–µ—Ä–∞—Ü–∏–π</span><span class="mini-stat-value" id="miniReportCount">0</span></div>
              <div class="mini-stat"><span class="mini-stat-label">–°—É–º–º–∞</span><span class="mini-stat-value" id="miniReportSum">0 ‚Ç∏</span></div>
            </div>
            <div class="mini-operations-list" id="miniOperationsList"></div>
          </div>
          <div class="card" id="searchCard">
            <div class="card-title" id="modeTitle">–ü—Ä–æ–¥–∞–∂–∞</div>
            <div class="search-box">
              <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." class="input" autocomplete="off">
              <button class="btn-icon" onclick="openScanner()">üì∑</button>
            </div>
            <div id="suggestions" class="suggestions"></div>
          </div>
          <div class="card" id="returnSearchBlock" style="display:none;">
            <div class="card-title">üîç –ù–∞–π—Ç–∏ –ø—Ä–æ–¥–∞–∂—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞</div>
            <div class="search-box"><input type="text" id="returnSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥–∞–∂–∏..." class="input" autocomplete="off"></div>
            <div id="returnResults" class="return-results"></div>
          </div>
          <div class="card" id="supplierBlock" style="display:none;">
            <div class="card-title">–ü–æ—Å—Ç–∞–≤—â–∏–∫ <span class="required">*</span></div>
            <select id="supplierSelect" class="input"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</option></select>
            <button class="btn-secondary" onclick="openNewSupplier()" style="margin-top:12px;">+ –ù–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫</button>
          </div>
          <div class="card" id="saleDetailsCard">
            <div class="card-title">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–¥–∞–∂–∏</div>
            <label class="label">–ö–ª–∏–µ–Ω—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="text" id="clientNameInput" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" class="input" autocomplete="off">
            <div id="clientSuggestions" class="suggestions"></div>
            <label class="label" style="margin-top:12px;">–°–∫–∏–¥–∫–∞</label>
            <div class="discount-row">
              <input type="number" id="discountPercent" placeholder="%" class="input" style="width:80px;" min="0" max="100">
              <span class="discount-or">–∏–ª–∏</span>
              <input type="number" id="discountAmount" placeholder="‚Ç∏" class="input" style="width:120px;" min="0">
            </div>
            <div class="discount-display">–°–∫–∏–¥–∫–∞: <strong id="discountDisplay">0 ‚Ç∏</strong></div>
          </div>
        </div>
        <div class="trading-right">
          <div class="card"><div class="card-title">–ß–µ–∫</div><div id="cart" class="cart"></div></div>
          <div class="card" id="paymentBlock">
            <div class="card-title">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
            <label class="radio-label"><input type="radio" name="paymentMethod" value="cash" checked><span>–ù–∞–ª</span></label>
            <label class="radio-label"><input type="radio" name="paymentMethod" value="card"><span>–ë–µ–∑–Ω–∞–ª</span></label>
          </div>
          <div class="card"><label class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="commentInput" placeholder="Kaspi, Halyk –∏ —Ç.–¥." class="input"></div>
          <div class="total-card"><span>–ò–¢–û–ì–û:</span><strong id="totalAmount">0 ‚Ç∏</strong></div>
          <button class="btn-primary btn-action" onclick="submitOperation()"><span id="actionBtn">–ü–†–û–î–ê–¢–¨</span></button>
        </div>
      </div>
    </section>

    <!-- PRODUCTS -->
    <section class="section" id="section-products">
      <div class="section-header">
        <h1 class="section-title">–¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏</h1>
        <div class="header-actions">
          <button class="btn-secondary" onclick="openNewProduct('product')">+ –¢–æ–≤–∞—Ä</button>
          <button class="btn-secondary" onclick="openNewProduct('service')">+ –£—Å–ª—É–≥–∞</button>
          <button class="btn-secondary" onclick="openImportModal()">üì• –ò–º–ø–æ—Ä—Ç</button>
        </div>
      </div>
      <div class="card">
        <input type="text" id="productSearchInput" placeholder="–ü–æ–∏—Å–∫..." class="input" oninput="filterProducts()">
        <div id="productsList" class="products-list"></div>
      </div>
    </section>

    <!-- SUPPLIERS -->
    <section class="section" id="section-suppliers">
      <div class="section-header">
        <h1 class="section-title">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</h1>
        <button class="btn-secondary" onclick="openNewSupplier()">+ –ù–æ–≤—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫</button>
      </div>
      <div class="card">
        <input type="text" id="supplierSearchInput" placeholder="–ü–æ–∏—Å–∫..." class="input" oninput="filterSuppliers()">
        <div id="suppliersList" class="suppliers-list"></div>
      </div>
    </section>

    <!-- CLIENTS -->
    <section class="section" id="section-clients">
      <div class="section-header">
        <h1 class="section-title">–ö–ª–∏–µ–Ω—Ç—ã</h1>
        <button class="btn-secondary" onclick="openNewClient()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
      </div>
      <div class="card">
        <input type="text" id="clientSearchInput" placeholder="–ü–æ–∏—Å–∫..." class="input" oninput="filterClients()">
        <div id="clientsList" class="clients-list"></div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section class="section" id="section-expenses">
      <div class="section-header">
        <h1 class="section-title">–†–∞—Å—Ö–æ–¥—ã</h1>
        <button class="btn-secondary" onclick="openNewExpense()">+ –ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showExpenseTab('list')">–°–ø–∏—Å–æ–∫</button>
        <button class="tab" onclick="showExpenseTab('categories')">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      </div>
      <div class="card" id="expensesListCard">
        <div class="filter-row">
          <div class="filter-group"><label class="label">–°</label><input type="date" id="expenseDateFrom" class="input"></div>
          <div class="filter-group"><label class="label">–ü–æ</label><input type="date" id="expenseDateTo" class="input"></div>
          <div class="filter-group"><label class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="expenseCategoryFilter" class="input"><option value="">–í—Å–µ</option></select></div>
          <button class="btn-secondary" onclick="loadExpenses()" style="align-self:flex-end;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div id="expensesList" class="expenses-list"></div>
      </div>
      <div class="card" id="expenseCategoriesCard" style="display:none;">
        <button class="btn-secondary" onclick="openNewCategory()">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
        <div id="categoriesList" class="categories-list"></div>
      </div>
    </section>

    <!-- REPORTS -->
    <section class="section" id="section-reports">
      <div class="section-header"><h1 class="section-title">–û—Ç—á—ë—Ç—ã</h1></div>
      <div class="card">
        <div class="filter-row">
          <div class="filter-group"><label class="label">–°</label><input type="date" id="reportDateFrom" class="input"></div>
          <div class="filter-group"><label class="label">–ü–æ</label><input type="date" id="reportDateTo" class="input"></div>
          <button class="btn-primary" onclick="loadReports()" style="align-self:flex-end;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="showReportTab('summary')">–°–≤–æ–¥–∫–∞</button>
        <button class="tab" onclick="showReportTab('bydays')">–ü–æ –¥–Ω—è–º</button>
        <button class="tab" onclick="showReportTab('byproducts')">–ü–æ —Ç–æ–≤–∞—Ä–∞–º</button>
        <button class="tab" onclick="showReportTab('money')">–î–µ–Ω—å–≥–∏</button>
        <button class="tab" onclick="showReportTab('pnl')">P&L</button>
        <button class="tab" onclick="showReportTab('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
      </div>
      <div id="reportContent"></div>
    </section>

    <!-- MONEY -->
    <section class="section" id="section-money">
      <div class="section-header"><h1 class="section-title">–î–µ–Ω—å–≥–∏</h1></div>
      <div class="stats-grid">
        <div class="stat-card purple"><div class="stat-label">–ù–∞–ª–∏—á–Ω—ã–µ</div><div class="stat-value" id="balanceCash">0 ‚Ç∏</div></div>
        <div class="stat-card teal"><div class="stat-label">–ë–µ–∑–Ω–∞–ª</div><div class="stat-value" id="balanceCard">0 ‚Ç∏</div></div>
        <div class="stat-card green"><div class="stat-label">–ò—Ç–æ–≥–æ</div><div class="stat-value" id="balanceTotal">0 ‚Ç∏</div></div>
      </div>
      <div class="card">
        <div class="card-title">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
        <div class="initial-balance-row">
          <div class="initial-balance-item"><label class="label">–ù–∞–ª–∏—á–Ω—ã–µ</label><input type="number" id="initialCash" class="input" value="0"></div>
          <div class="initial-balance-item"><label class="label">–ë–µ–∑–Ω–∞–ª</label><input type="number" id="initialCard" class="input" value="0"></div>
          <button class="btn-secondary" onclick="saveInitialBalance()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">–û–ø–µ—Ä–∞—Ü–∏–∏</div>
        <div class="header-actions" style="margin-bottom:16px;">
          <button class="btn-secondary" onclick="openMoneyOperation('deposit')">+ –í–Ω–µ—Å—Ç–∏</button>
          <button class="btn-secondary" onclick="openMoneyOperation('withdraw')">‚àí –ò–∑—ä—è—Ç—å</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="filter-row">
          <div class="filter-group"><label class="label">–°</label><input type="date" id="moneyDateFrom" class="input"></div>
          <div class="filter-group"><label class="label">–ü–æ</label><input type="date" id="moneyDateTo" class="input"></div>
          <button class="btn-secondary" onclick="loadMoneyHistory()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div id="moneyHistoryList" class="money-history"></div>
      </div>
    </section>
  </main>

  <!-- MOBILE NAV -->
  <nav class="mobile-nav">
    <button class="mobile-nav-item active" data-section="trading" onclick="showSection('trading')"><span class="mobile-nav-icon">üõí</span><span class="mobile-nav-label">–¢–æ—Ä–≥–æ–≤–ª—è</span></button>
    <button class="mobile-nav-item" data-section="products" onclick="showSection('products')"><span class="mobile-nav-icon">üì¶</span><span class="mobile-nav-label">–¢–æ–≤–∞—Ä—ã</span></button>
    <button class="mobile-nav-item" data-section="expenses" onclick="showSection('expenses')"><span class="mobile-nav-icon">üí∏</span><span class="mobile-nav-label">–†–∞—Å—Ö–æ–¥—ã</span></button>
    <button class="mobile-nav-item" data-section="reports" onclick="showSection('reports')"><span class="mobile-nav-icon">üìä</span><span class="mobile-nav-label">–û—Ç—á—ë—Ç—ã</span></button>
    <button class="mobile-nav-item" data-section="money" onclick="showSection('money')"><span class="mobile-nav-icon">üí∞</span><span class="mobile-nav-label">–î–µ–Ω—å–≥–∏</span></button>
  </nav>

  <!-- MODALS -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="productModalTitle">–¢–æ–≤–∞—Ä</h2><button class="modal-close" onclick="closeModal('productModal')">‚úï</button></div>
      <div class="modal-body">
        <input type="hidden" id="productId">
        <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="productName" class="input">
        <div class="form-row">
          <div><label class="label">SKU</label><input type="text" id="productSku" class="input"></div>
          <div><label class="label">–®—Ç—Ä–∏—Ö–∫–æ–¥</label><input type="text" id="productBarcode" class="input"></div>
        </div>
        <div class="form-row">
          <div><label class="label">–¢–∏–ø</label><select id="productType" class="input"><option value="product">–¢–æ–≤–∞—Ä</option><option value="service">–£—Å–ª—É–≥–∞</option></select></div>
          <div><label class="label">–ï–¥.</label><select id="productUnit" class="input"><option value="—à—Ç">—à—Ç</option><option value="–∫–≥">–∫–≥</option><option value="–ª">–ª</option><option value="–º">–º</option></select></div>
        </div>
        <div class="form-row">
          <div><label class="label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</label><input type="number" id="productPurchasePrice" class="input"></div>
          <div><label class="label">–¶–µ–Ω–∞ *</label><input type="number" id="productSalePrice" class="input"></div>
        </div>
        <div id="productQtyGroup"><label class="label">–û—Å—Ç–∞—Ç–æ–∫</label><input type="number" id="productQty" class="input" value="0"></div>
        <div id="productStatusGroup" style="display:none;"><label class="label">–°—Ç–∞—Ç—É—Å</label><select id="productActive" class="input"><option value="true">–ê–∫—Ç–∏–≤–µ–Ω</option><option value="false">–ê—Ä—Ö–∏–≤</option></select></div>
        <button class="btn-primary" onclick="saveProduct()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-danger" id="deleteProductBtn" onclick="deleteProduct()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal" id="supplierModal">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h2 id="supplierModalTitle">–ü–æ—Å—Ç–∞–≤—â–∏–∫</h2><button class="modal-close" onclick="closeModal('supplierModal')">‚úï</button></div>
      <div class="modal-body">
        <input type="hidden" id="supplierId">
        <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="supplierName" class="input">
        <label class="label">–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="supplierPhone" class="input">
        <label class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="supplierComment" class="input textarea"></textarea>
        <div id="supplierStatusGroup" style="display:none;"><label class="label">–°—Ç–∞—Ç—É—Å</label><select id="supplierActive" class="input"><option value="true">–ê–∫—Ç–∏–≤–µ–Ω</option><option value="false">–ê—Ä—Ö–∏–≤</option></select></div>
        <button class="btn-primary" onclick="saveSupplier()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-danger" id="deleteSupplierBtn" onclick="deleteSupplier()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal" id="clientModal">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h2 id="clientModalTitle">–ö–ª–∏–µ–Ω—Ç</h2><button class="modal-close" onclick="closeModal('clientModal')">‚úï</button></div>
      <div class="modal-body">
        <input type="hidden" id="clientId">
        <label class="label">–ò–º—è *</label><input type="text" id="clientName" class="input">
        <label class="label">–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="clientPhone" class="input">
        <label class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="clientComment" class="input textarea"></textarea>
        <button class="btn-primary" onclick="saveClient()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-danger" id="deleteClientBtn" onclick="deleteClient()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal" id="clientHistoryModal">
    <div class="modal-content modal-lg">
      <div class="modal-header"><h2 id="clientHistoryTitle">–ò—Å—Ç–æ—Ä–∏—è</h2><button class="modal-close" onclick="closeModal('clientHistoryModal')">‚úï</button></div>
      <div class="modal-body"><div id="clientHistoryContent"></div></div>
    </div>
  </div>

  <div class="modal" id="expenseModal">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h2>–†–∞—Å—Ö–æ–¥</h2><button class="modal-close" onclick="closeModal('expenseModal')">‚úï</button></div>
      <div class="modal-body">
        <label class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label><select id="expenseCategory" class="input"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option></select>
        <label class="label">–°—É–º–º–∞ *</label><input type="number" id="expenseAmount" class="input">
        <label class="label">–°–ø–æ—Å–æ–±</label><select id="expensePaymentMethod" class="input"><option value="cash">–ù–∞–ª</option><option value="card">–ë–µ–∑–Ω–∞–ª</option></select>
        <label class="label">–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="expenseDescription" class="input">
        <button class="btn-primary" onclick="saveExpense()">–î–û–ë–ê–í–ò–¢–¨</button>
      </div>
    </div>
  </div>

  <div class="modal" id="categoryModal">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2><button class="modal-close" onclick="closeModal('categoryModal')">‚úï</button></div>
      <div class="modal-body">
        <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="categoryName" class="input">
        <label class="label">–¶–≤–µ—Ç</label><input type="color" id="categoryColor" class="input color-input" value="#ef4444">
        <button class="btn-primary" onclick="saveCategory()">–°–û–ó–î–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <div class="modal" id="moneyModal">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h2 id="moneyModalTitle">–û–ø–µ—Ä–∞—Ü–∏—è</h2><button class="modal-close" onclick="closeModal('moneyModal')">‚úï</button></div>
      <div class="modal-body">
        <input type="hidden" id="moneyOperationType">
        <label class="label">–°—É–º–º–∞ *</label><input type="number" id="moneyAmount" class="input">
        <label class="label">–°–ø–æ—Å–æ–±</label><select id="moneyPaymentMethod" class="input"><option value="cash">–ù–∞–ª</option><option value="card">–ë–µ–∑–Ω–∞–ª</option></select>
        <label class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="moneyComment" class="input">
        <button class="btn-primary" onclick="saveMoneyOperation()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
      </div>
    </div>
  </div>

  <div class="modal" id="importModal">
    <div class="modal-content">
      <div class="modal-header"><h2>–ò–º–ø–æ—Ä—Ç Excel</h2><button class="modal-close" onclick="closeModal('importModal')">‚úï</button></div>
      <div class="modal-body">
        <p class="modal-hint">–§–æ—Ä–º–∞—Ç: –¢–∏–ø | –ù–∞–∑–≤–∞–Ω–∏–µ | SKU | –ö–æ–ª-–≤–æ | –°–µ–±–µ—Å—Ç. | –¶–µ–Ω–∞</p>
        <input type="file" id="importFile" class="input" accept=".xlsx,.xls,.csv">
        <button class="btn-primary" onclick="importProducts()">–ò–ú–ü–û–†–¢</button>
        <div id="importResults" style="margin-top:16px;"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="adminPasswordModal">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h2>–£–¥–∞–ª–µ–Ω–∏–µ</h2><button class="modal-close" onclick="closeModal('adminPasswordModal')">‚úï</button></div>
      <div class="modal-body">
        <input type="hidden" id="deleteOperationId"><input type="hidden" id="deleteOperationType">
        <p class="modal-hint">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <input type="password" id="adminPassword" class="input">
        <button class="btn-danger" onclick="confirmDelete()">–£–î–ê–õ–ò–¢–¨</button>
      </div>
    </div>
  </div>

  <div class="scanner-overlay" id="scannerOverlay">
    <video id="scannerVideo" autoplay playsinline></video>
    <button class="scanner-close" onclick="closeScanner()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="app.js"></script>
  <script>
    if (window.CURRENT_USER) document.getElementById('userName').textContent = window.CURRENT_USER.name || window.CURRENT_USER.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    
    async function logout() { 
      if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) { 
        // Clear Supabase session if exists
        try {
          const SUPABASE_URL = "https://mpwyzefkazbgnastcahd.supabase.co";
          const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wd3l6ZWZrYXpiZ25hc3RjYWhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDg4NTUsImV4cCI6MjA4NTAyNDg1NX0.9bcksevoXtniNvcUiFYhcmWzd8xHDmsY75FJljPO-_4";
          const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          await db.auth.signOut();
        } catch (e) { console.log('Logout:', e); }
        
        localStorage.removeItem('kassir_user'); 
        window.location.replace('login.html'); 
      } 
    }
    
    // Check role for admin features
    function isAdmin() {
      return window.CURRENT_USER && window.CURRENT_USER.role === 'admin';
    }
    
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(e => console.log('SW:', e));
  </script>
</body>
</html>
